---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
import Modal from "../components/Modal.astro";

// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout>
  <Modal />
  <button
    id="btnModal"
    class="absolute right-0 top-0 m-7 bg-gray-100 hover:bg-gray-300 transition size-8 rounded flex items-center justify-center"
    >?</button
  >
  <form
    id="productForm"
    action=""
    class="w-[80%] md:w-[70%] lg:w-[40%] flex flex-col gap-2"
  >
    <h1 class="text-2xl">ðŸ”— Introduce la URL del producto para comenzar</h1>
    <div class="w-full flex gap-3">
      <input
        id="url"
        name="url"
        class="border p-2 rounded w-full"
        type="text"
        placeholder="url del producto"
        required
      />
      <button
        id="resetButton"
        class="bg-amber-500 border border-amber-500 hover:bg-amber-600 px-4 py-2 rounded"
        type="reset">Reiniciar</button
      >
    </div>
  </form>
  <div
    class="productCard hidden flex items-center justify-center w-[80%] md:w-[70%] lg:w-[40%] text-center"
  >
    <div
      class="w-full p-2 border border-gray-500 rounded flex flex-col md:flex-row items-center gap-4"
    >
      <img
        id="productImage"
        class="size-[50%] md:h-full lg:h-full lg:w-[40%] aspect-square"
        src=""
        alt="Imagen del producto"
      />
      <div class="flex flex-col justify-start gap-2">
        <h2 id="productTitle" class="font-bold"></h2>
        <span id="productPrice" class="font-bold"></span>
        <div class="flex flex-col gap-3">
          <h2 class="text-gray-500">
            Â¿Quieres recibir un correo cuando el precio disminuya?
          </h2>
          <form id="emailForm" class="w-full">
            <div class="flex flex-col items-start gap-2">
              <span id="emailMessage" class="font-light text-[0.9rem]"> </span>
              <div class="flex w-full gap-4">
                <input
                  id="userEmail"
                  name="userEmail"
                  class="w-full border px-2 py-1 rounded"
                  type="email"
                  placeholder="correo@electronico.com"
                  required
                />
                <button
                  id="sendEmailButton"
                  class="bg-amber-500 border border-amber-500 hover:bg-amber-600 px-4 py-2 rounded"
                  type="submit">Recibir</button
                >
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Peticion para obtener el producto

    const productInput = document.getElementById("url") as HTMLInputElement;
    const container = document.querySelector(".productCard") as HTMLDivElement;

    const productImg = document.getElementById(
      "productImage"
    ) as HTMLImageElement;
    const productTitle = document.getElementById("productTitle");
    const productPrice = document.getElementById("productPrice");

    const emailInput = document.getElementById("userEmail") as HTMLInputElement;
    const emailForm = document.getElementById("emailForm") as HTMLFormElement;
    const sendEmailButton = document.getElementById(
      "sendEmailButton"
    ) as HTMLButtonElement;
    const emailMessage = document.getElementById(
      "emailMessage"
    ) as HTMLSpanElement;

    let timeout: number | undefined;

    productInput.addEventListener("input", async () => {
      const url = productInput.value;

      if (!url) return;

      if (timeout) clearTimeout(timeout);
      timeout = window.setTimeout(() => {
        fetchProduct(url);
      }, 1000);
    });

    async function fetchProduct(url: string) {
      emailMessage.textContent = "";
      emailMessage.classList.remove("text-green-300", "text-red-300");
      sendEmailButton.disabled = false;
      emailInput.disabled = false;

      try {
        const res = await fetch(
          // "https://rastreador-precios-amazon.onrender.com/api/scrape",
          "http://127.0.0.1:5000/api/scrape",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          }
        );

        const data = await res.json();

        if (productTitle) productTitle.textContent = data.title;
        if (productPrice) productPrice.textContent = data.price + " â‚¬";
        if (productImg) productImg.src = data.img_url;

        container.classList.remove("hidden");
      } catch (error) {
        console.log("Error al scrapear");
      }
    }

    emailForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userEmail = emailInput.value;

      try {
        const res = await fetch(
          // "https://rastreador-precios-amazon.onrender.com/api/email_sender",
          "http://127.0.0.1:5000/api/email_sender",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userEmail }),
          }
        );

        if (res.ok) {
          emailMessage.textContent = "Correo enviado con Ã©xito";
          emailMessage.classList.add("text-green-300");
          emailInput.value = "";
          sendEmailButton.disabled = true;
          emailInput.disabled = true;
        } else {
          emailMessage.classList.add("text-red-300");
          emailMessage.textContent = "Error al enviar el correo";
        }
      } catch (error) {
        console.log("Algo ha salido mal:", error);
      }
    });

    const resetButton = document.getElementById("resetButton");
    resetButton?.addEventListener("click", () => {
      if (productTitle) productTitle.textContent = "";
      if (productPrice) productPrice.textContent = "";
      if (productImg) productImg.src = "";

      container.classList.add("hidden");
    });

    // Boton para mostrar/ocultar el modal
    const modal = document.getElementById("modal");
    const btnModal = document.getElementById("btnModal");
    const closeModal = document.getElementById("closeModal");

    btnModal?.addEventListener("click", () => {
      modal?.classList.remove("hidden");
    });

    closeModal?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });
  </script>
</Layout>
